From 9559eb22c61eb866f900226830858ba5be025b7e Mon Sep 17 00:00:00 2001
From: Maarten Baert <maarten-baert@hotmail.com>
Date: Sun, 6 Oct 2024 14:49:54 +0200
Subject: [PATCH] Prepare for future FFmpeg compatibility

---
 src/AV/Output/BaseEncoder.cpp | 2 ++
 src/Global.h                  | 3 +++
 2 files changed, 5 insertions(+)

diff --git a/src/AV/Output/BaseEncoder.cpp b/src/AV/Output/BaseEncoder.cpp
index 7c01ef30..5e8f5c82 100644
--- a/src/AV/Output/BaseEncoder.cpp
+++ b/src/AV/Output/BaseEncoder.cpp
@@ -176,7 +176,9 @@ void BaseEncoder::Init(AVCodec* codec, AVDictionary** options) {
 
 void BaseEncoder::Free() {
 	if(m_codec_opened) {
+#if !SSR_USE_AVCODEC_CLOSE_DEPRECATED
 		avcodec_close(m_codec_context);
+#endif
 		m_codec_opened = false;
 	}
 }
diff --git a/src/Global.h b/src/Global.h
index a6633e3a..a572e6d5 100644
--- a/src/Global.h
+++ b/src/Global.h
@@ -257,6 +257,9 @@ inline void atomic_thread_fence_replacement(memory_order) {
 // avformat_free_context: lavf 52.96.0 / 52.96.0
 #define SSR_USE_AVFORMAT_FREE_CONTEXT              TEST_AV_VERSION(LIBAVFORMAT, 52, 96, 52, 96)
 
+// avcodec_close deprecated: lavc 60.39.100 / ???
+// - ffmpeg: missing, commit: https://github.com/FFmpeg/FFmpeg/commit/1cc24d749569a42510399a29b034f7a77bdec34e
+#define SSR_USE_AVCODEC_CLOSE_DEPRECATED           TEST_AV_VERSION(LIBAVCODEC, 60, 39, 999, 999)
 // AVChannelLayout, ch_layout: lavc 59.24.100 / ???
 #define SSR_USE_AV_CHANNEL_LAYOUT                  TEST_AV_VERSION(LIBAVCODEC, 59, 24, 999, 999)
 // av_codec_iterate: lavc 58.10.100 / ???
